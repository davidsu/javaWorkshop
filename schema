DROP DATABASE IF EXISTS java_workshop;
CREATE DATABASE java_workshop;
use java_workshop;

-- table creation
CREATE TABLE users(
    id int NOT NULL AUTO_INCREMENT,
    full_name VARCHAR(255) NOT NULL,
    type VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    UNIQUE(email),
    PRIMARY KEY (id)
);

CREATE TABLE products(
    id int NOT NULL AUTO_INCREMENT,
    productName VARCHAR(50),
    PRIMARY KEY (id)
);

CREATE TABLE taskTypes(
    id int NOT NULL AUTO_INCREMENT,
    taskType VARCHAR(50),
    PRIMARY KEY (id)
);

CREATE TABLE environments(
    id int NOT NULL AUTO_INCREMENT,
    envName VARCHAR(50),
    PRIMARY KEY (id)
);

CREATE TABLE additionalInfo(
    id int NOT NULL AUTO_INCREMENT,
    information TEXT,
    PRIMARY KEY (id)
);


CREATE TABLE tasks(
    id int NOT NULL AUTO_INCREMENT,
    taskTypeId int,
    productId int,
    envId int,
    requesterId int,
    priority int,
    open_date DATE NOT NULL,
    exec_date DATE,
    status VARCHAR(20),
    qaGO bool,
    rollBack bool,
    urgent bool,
    additionalInfoId int,
    assigneeId int,
    resolved_by_Id int,
    -- you can't delete a user from the database without first assigning its tasks to some other user
    FOREIGN KEY (requesterId) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (assigneeId) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (resolved_by_Id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (taskTypeId) REFERENCES taskTypes(id) ON DELETE RESTRICT,
    FOREIGN KEY (productId) REFERENCES products(id) ON DELETE RESTRICT,
    FOREIGN KEY (envId) REFERENCES environments(id) ON DELETE RESTRICT,
    FOREIGN KEY (additionalInfoId) REFERENCES additionalInfo(id) ON DELETE RESTRICT,
    PRIMARY KEY (id)
);

-- populate some basic data
INSERT INTO users (full_name,type,email,password) VALUES ('David Susskind', 'admin', 'dchamud@gmail.com', 'bla');
INSERT INTO users (full_name,type,email,password) VALUES ('Barak Obama', 'admin', 'barakobama@gmail.com',  'bla');
INSERT INTO users (full_name,type,email,password) VALUES ('Luiz Inacio', 'admin', 'luizinacio@gmail.com', 'bla');
INSERT INTO users (full_name,type,email,password) VALUES ('Alon Dangaur', 'admin', 'alondx2@gmail.com', 'bla');
INSERT INTO users (full_name,type,email,password) VALUES ('benjamin netanyahu', 'admin', 'benjaminnetanyahu@gmail.com', 'bla');


INSERT INTO products (productName) VALUES ('WebApp1');
INSERT INTO products (productName) VALUES ('WebApp2');

INSERT INTO taskTypes (taskType) VALUES ('Installation');
INSERT INTO taskTypes (taskType) VALUES ('Configuration');

INSERT INTO environments (envName) VALUES ('Beta');
INSERT INTO environments (envName) VALUES ('UAT');
INSERT INTO environments (envName) VALUES ('Production');


DROP PROCEDURE IF EXISTS `addTask`;
DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `addTask`
(
    IN taskTypeId int,
    IN productId int,
    IN envId int,
    IN requesterId int,
    IN priority int,
    IN open_date DATE,
    IN status VARCHAR(20),
    IN qaGO bool,
    IN rollBack bool,
    IN urgent bool,
    IN additionalInfoText TEXT
)
BEGIN
     DECLARE additionalInfoId int DEFAULT NULL;
     IF (additionalInfoText IS NOT NULL) THEN
         BEGIN
            INSERT INTO additionalInfo (information) VALUES (additionalInfoText);
            SET additionalInfoId = LAST_INSERT_ID();
         END;
     END IF;
     INSERT INTO tasks (taskTypeId,productId,envId,requesterId,priority,open_date,exec_date,status,qaGO,rollBack,urgent,additionalInfoId,assigneeId,resolved_by_Id)
     VALUE (taskTypeId,productId,envId,requesterId,priority,open_date,NULL,status,qaGO,rollBack,urgent,additionalInfoId,NULL,NULL);
END;
$$


INSERT INTO tasks (taskTypeId,productId,envId,requesterId,priority,open_date,exec_date,status,qaGO,rollBack,urgent,additionalInfoId,assigneeId,resolved_by_Id)
VALUE (1, 1, 3, 2, 1, '2017-03-11', NULL, 'New', 1, 1, 0, NULL, NULL, NULL);

CALL addTask (1, 2, 3, 1, 2, '2017-03-11','New', 1, 1, 0,'this is a test' );